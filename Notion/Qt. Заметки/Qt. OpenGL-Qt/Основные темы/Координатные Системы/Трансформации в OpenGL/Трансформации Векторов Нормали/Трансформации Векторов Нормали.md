---

---
---

Данная заметка перевод [вот этой](http://www.songho.ca/opengl/gl_normaltransform.html) статьи.

---

Данная заметка является расширенной версией [[Трансформации в OpenGL]]_**[[Трансформации в OpenGL]]**_. И отвечает на вопрос, почему трансформация векторов нормали из _**Пространства Объекта**_ в _**Пространство Наблюдателя**_, выглдяит именно так:

$$
\begin{pmatrix} n\textcolor{#FF0000}{x_{eye}} \\ n\textcolor{#01FF00}{y_{eye}} \\ n\textcolor{#0000FF}{z_{eye}} \\ nw_{eye} \\ \end{pmatrix} \ =\ \big((M_{ModelView})^{-1}\big)^{T} \cdot \begin{pmatrix} n\textcolor{#FF0000}{x_{object}} \\ n\textcolor{#01FF00}{y_{object}} \\ n\textcolor{#0000FF}{z_{object}} \\ nw_{object} \\ \end{pmatrix}
$$

Когда в воркфлоу рендеринга **OpenGL** включен свет, _нормальные вектора_ используются для определения - как много света попадает на выбранный нами вертекс или плоскость.

А как известно - обработка освещения происходит как раз-таки в _**Пространстве Наблюдателя**_, следовательно, вектора нормали, которые находились до этого в _**Координатах Объекта**_ должны быть так же трансформированы в _**Координаты Наблюдателя**_ при помощи _Матрицы Модель/Представления_.

При этом не стоит забывать, что вектора нормали транформируются отличным от вертексов образом. Мы не можем просто на дурака умножить _Матрицу Модель/Представления_ и _вектор нормали_. К примеру, возьмем _вектор нормали_ $(1, 0, 0)$﻿ для вершины $(0, 0, 0)$﻿. Если Матрица Модели/Представления будет банально транслировать вершины на две единицы по оси $\textcolor{#01FF00}{+Y}$﻿, то вершина будет иметь координаты $(0, 2, 0)$﻿, но вектор нормали должен оставаться с координатой $(1, 0, 0)$﻿, а не $(1, 2, 0)$﻿.

Для лучшего понимания, как _нормали_ трансформируются в Пространство Наблюдателя, стоит размышлять о них как о коэффициентах [[Уравнение Плоскости]], которые будут перпедикулярны этой самой плоскости.

![[surface_normal_vector.svg]]

Представим треугольный полигон с 3 вершинами: $\overrightarrow{v_{1}}-\overrightarrow{v_{2}}-\overrightarrow{v_{3}}$﻿ и с нормалью проведенной от этой поверхности: $\overrightarrow{n} = ( n_{\textcolor{#FF0000}{x}}, n_{\textcolor{#01FF00}{y}}, n_{\textcolor{#0000FF}{z}}, n_{w} )$﻿ на [[Гомогенные Координаты]] (Для евклидовых координат, нормаль будет выглядеть как $( n_{\textcolor{#FF0000}{x}}, n_{\textcolor{#01FF00}{y}}, n_{\textcolor{#0000FF}{z}})$﻿.  
Если мы размышляем о этом треугольнике, как о [[Уравнение Плоскости]] в [[Гомогенные Координаты]] то мы получим следующую картину:
$$
\begin{split} \overrightarrow{n} \cdot \overrightarrow{v} \ &= \ 0 \\ ( n_{\textcolor{#FF0000}{x}}, n_{\textcolor{#01FF00}{y}}, n_{\textcolor{#0000FF}{z}}, n_{w} ) \cdot ( \textcolor{#FF0000}{x}, \textcolor{#01FF00}{y}, \textcolor{#0000FF}{z}, w ) &= 0 \\ n_{\textcolor{#FF0000}{x}} \textcolor{#FF0000}{x} + n_{\textcolor{#01FF00}{y}} \textcolor{#01FF00}{y} + n_{\textcolor{#0000FF}{z}} \textcolor{#0000FF}{z} + n_{w} w &= 0 \end{split}
$$
Так как 3 вертекса лежат на одной плоскости, то уравнение этой плоскости, которое мы написали выше применимо к каждой вершине $v$﻿, к примеру: для вершины
$\overrightarrow{v_{1}} = ( \textcolor{#FF0000}{x_{1}}, \textcolor{#01FF00}{y_{1}}, \textcolor{#0000FF}{z_{1}}, w_{1} )$﻿, удовлетворяет уравнение $n_{\textcolor{#FF0000}{x}} \textcolor{#FF0000}{x_{1}} + n_{\textcolor{#01FF00}{y}} \textcolor{#01FF00}{y_{1}} + n_{\textcolor{#0000FF}{z}} \textcolor{#0000FF}{z_{1}} + n_{w} w_{1} = 0$﻿  
И переписав данное скалярное произведение в матричный вид (Переписав, по факту, в виде трансформации) получим:  
$$
\begin{pmatrix} n_{\textcolor{#FF0000}{x}} & n_{\textcolor{#01FF00}{y}} & n_{\textcolor{#0000FF}{z}} & n_{w} \end{pmatrix} \begin{pmatrix} \textcolor{#FF0000}{x} \\ \textcolor{#01FF00}{y} \\ \textcolor{#0000FF}{z} \\ w \end{pmatrix} = 0
$$
То есть уравнение плоскости умнажается на транспонированный вектор нормали $n^{T}$﻿ и на вершину $v$﻿ одновременно. Другими словами: “Вертекс $v$﻿ в _**Пространстве Объекта**_ лежит на плоскости с нормалью $\overrightarrow{n}$﻿”  
Теперь нам надо применить трансформацию $M$﻿ (Это матрица Модели/Представления), к получившемуся уравнению плоскости. Вспоминая про правило $M^{-1}M = I$﻿, получим:
$$
\underbrace{ \begin{pmatrix} n_{\textcolor{#FF0000}{x}} & n_{\textcolor{#01FF00}{y}} & n_{\textcolor{#0000FF}{z}} & n_{w} \end{pmatrix} M^{-1} }_\textrm{ Трансформация Нормали } \underbrace{ M \begin{pmatrix} \textcolor{#FF0000}{x} \\ \textcolor{#01FF00}{y} \\ \textcolor{#0000FF}{z} \\ w \end{pmatrix} }_\textrm{ Трансформация Ветора } = 0
$$
(Обратим внимание, что по факту выражение не изменилось, потому $M^{-1}M = I$﻿, где $I$﻿ - единичная матрица)

Получается, что правая часть $M \begin{pmatrix} \textcolor{#FF0000}{x} \\ \textcolor{#01FF00}{y} \\ \textcolor{#0000FF}{z} \\ w \end{pmatrix}$﻿ - это вершина в _**Координатах Наблюдателя**_, потому что идет умножение вектора $v$﻿ (вертекса как раз) на матрицу $M$﻿ (как раз матрицу Модель/Представления), а левая $\begin{pmatrix} n_{\textcolor{#FF0000}{x}} & n_{\textcolor{#01FF00}{y}} & n_{\textcolor{#0000FF}{z}} & n_{w} \end{pmatrix} M^{-1}​$﻿ - это вектор нормали, который представлен так же в _**Координатах Наблюдателя**_.

Другими словами: “Преобразованная матрица $Mv$﻿ лежит на преобразованной плоскости в Координатах Наблюдателя с преобразованной нормалью $n^{T}M^{-1}$﻿”.

Следовательно, трансформирование нормали из _**Объектного Пространства**_ в _**Пространство Наблюдателя**_ при помощи матрицы _**Модели/Вида**_ $M$﻿ выглядит так:
$$
\begin{pmatrix} n\textcolor{#FF0000}{x_{eye}} \\ n\textcolor{#01FF00}{y_{eye}} \\ n\textcolor{#0000FF}{z_{eye}} \\ nw_{eye} \\ \end{pmatrix} \ =\ \begin{pmatrix} n\textcolor{#FF0000}{x_{obj}} & n\textcolor{#01FF00}{y_{obj}} & n\textcolor{#0000FF}{z_{obj}} & nw_{obj} \end{pmatrix} M^{-1}
$$
Или, преобразуя предварительное умножение в последующее, мы получаем:
$$
\begin{pmatrix} n\textcolor{#FF0000}{x_{eye}} \\ n\textcolor{#01FF00}{y_{eye}} \\ n\textcolor{#0000FF}{z_{eye}} \\ nw_{eye} \\ \end{pmatrix} \ =\ (M^{-1})^{T} \begin{pmatrix} n\textcolor{#FF0000}{x_{obj}} \\ n\textcolor{#01FF00}{y_{obj}} \\ n\textcolor{#0000FF}{z_{obj}} \\ nw_{obj} \end{pmatrix}
$$
## Пример использования: Только Трансляция

Предположим, что вектор нормали это $(\textcolor{#FF0000}{0}, \textcolor{#01FF00}{0}, \textcolor{#0000FF}{1})$﻿ и матрица имеет только часть, отвечающую за трансляцию, перемещающую вершины в $(\textcolor{#FF0000}{1}, \textcolor{#01FF00}{2}, \textcolor{#0000FF}{3})$﻿
1. Тогда матрица трансляции:
	$$
	M \ =\ \begin{pmatrix} 1 & 0 & 0 & 2 \\ 0 & 1 & 0 & 3 \\ 0 & 0 & 1 & 4 \\ 0 & 0 & 0 & 1 \end{pmatrix}
	$$
2. Обратная матрица трансляции:
    $$
    M^{-1} \ =\ \begin{pmatrix} 1 & 0 & 0 & -2 \\ 0 & 1 & 0 & -3 \\ 0 & 0 & 1 & -4 \\ 0 & 0 & 0 & 1 \end{pmatrix}
    $$
3. Транспонированная матрица $(M^{-1})^{T}$﻿:
    $$
    (M^{-1})^{T} \ =\ \begin{pmatrix} 1 & 0 & 0 & 0 \\ 0 & 1 & 0 & 0 \\ 0 & 0 & 1 & 0 \\ -2 & -3 & -4 & 1 \end{pmatrix}
    $$
4. Трансформированный вектор нормали:
	$$
	n' = (M^{-1})^{T}n \ =\ \begin{pmatrix} 1 & 0 & 0 & 0 \\ 0 & 1 & 0 & 0 \\ 0 & 0 & 1 & 0 \\ -2 & -3 & -4 & 1 \end{pmatrix} \begin{pmatrix} \textcolor{#FF0000}{0} \\ \textcolor{#01FF00}{0} \\ \textcolor{#0000FF}{1} \\ 1 \end{pmatrix} = \begin{pmatrix} \textcolor{#FF0000}{0} \\ \textcolor{#01FF00}{0} \\ \textcolor{#0000FF}{1} \\ -3 \end{pmatrix} 
	$$
То есть вектор нормали $(\textcolor{#FF0000}{0}, \textcolor{#01FF00}{0}, \textcolor{#0000FF}{1})​$﻿ остается не тронутым после трансляции, но конкретно в этом случае - все работает только при трансляции. Так же обратим внимание, что $n_w$﻿ компонента изменилась на $-3$﻿, но это никак не заафектило ни направления, ни длины нормали.

## Пример использования: Только Поворот

Если матрица трансформации содержит только поворот, то нормаль также вращается, как и вершина. Сейчас покажем матрицу, которая вращается на 30 градусов вокруг оси $\textcolor{\#FF0000}{X}$﻿ и трансформирует вектор нормали $(\textcolor{#FF0000}{0}, \textcolor{#01FF00}{0}, \textcolor{#0000FF}{1})​$﻿.
1. Матрица трансляции:
    $$
    M \ =\ \begin{pmatrix} 1 & 0 & 0 & 0 \\ 0 & 0.866 & -0.5 & 0 \\ 0 & 0.5 & 0.866 & 0 \\ 0 & 0 & 0 & 1 \end{pmatrix}
    $$
2. Обратная матрица трансляции:
    $$
    M^{-1} \ =\ \begin{pmatrix} 1 & 0 & 0 & 0 \\ 0 & 0.866 & 0.5 & 0 \\ 0 & -0.5 & 0.866 & 0 \\ 0 & 0 & 0 & 1 \end{pmatrix}
    $$
3. Транспонированная матрица $(M^{-1})^{T}$﻿:
    $$
    (M^{-1})^{T} \ =\ \begin{pmatrix} 1 & 0 & 0 & 0 \\ 0 & 0.866 & -0.5 & 0 \\ 0 & 0.5 & 0.866 & 0 \\ -2 & -3 & -4 & 1 \end{pmatrix}
    $$
4. Трансформированный вектор нормали:
$$
n' = (M^{-1})^{T}n \ =\ \begin{pmatrix} 1 & 0 & 0 & 0 \\ 0 & 0.866 & -0.5 & 0 \\ 0 & 0.5 & 0.866 & 0 \\ -2 & -3 & -4 & 1 \end{pmatrix} \begin{pmatrix} \textcolor{#FF0000}{0} \\ \textcolor{#01FF00}{0} \\ \textcolor{#0000FF}{1} \\ 1 \end{pmatrix} = \begin{pmatrix} \textcolor{#FF0000}{0} \\ \textcolor{#01FF00}{-0.5} \\ \textcolor{#0000FF}{0.866} \\ 1 \end{pmatrix}
$$
Обратим внимание, что матрица в которой присутсвует только Поворот - не изменяется после инвертированной транспозиции, из-за своей ортоганальности (обратная матрица равняется транспонированной матрице). И следовательно нам не нужно высчитывать и обртаную и транспонированную, если цель трансформации - только поворот. Мы можем просто умножать матрицу Трансформации напрямую на нормаль.

## Пример использования: Только Скейлинг

Предположим, что у нас есть трансформация нормали $( \textcolor{#FF0000}{0}, \textcolor{#01FF00}{0.6}, \textcolor{#0000FF}{0.8})$﻿ на скейл $( \textcolor{#FF0000}{2}, \textcolor{#01FF00}{4}, \textcolor{#0000FF}{5})​$﻿. Тогда матрицы будут выглядеть вот так:

1. Матрица трансляции:
    $$
	M \ =\ \begin{pmatrix} 2 & 0 & 0 & 0 \\ 0 & 4 & 0 & 0 \\ 0 & 0 & 5 & 0 \\ 0 & 0 & 0 & 1 \end{pmatrix}
    $$
2. Обратная матрица трансляции:
$$
M^{-1} \ =\ \begin{pmatrix} 0.5 & 0 & 0 & 0 \\ 0 & 0.25 & 0 & 0 \\ 0 & 0 & 0.2 & 0 \\ 0 & 0 & 0 & 1 \end{pmatrix}
$$
1. Транспонированная матрица $(M^{-1})^{T}$﻿:
$$
(M^{-1})^{T} \ =\ \begin{pmatrix} 0.5 & 0 & 0 & 0 \\ 0 & 0.25 & 0 & 0 \\ 0 & 0 & 0.2 & 0 \\ 0 & 0 & 0 & 1 \end{pmatrix}
$$
1. Трансформированный вектор нормали:
$$
n' = (M^{-1})^{T}n \ =\ \begin{pmatrix} 0.5 & 0 & 0 & 0 \\ 0 & 0.25 & 0 & 0 \\ 0 & 0 & 0.2 & 0 \\ 0 & 0 & 0 & 1 \end{pmatrix} \begin{pmatrix} \textcolor{#FF0000}{0} \\ \textcolor{#01FF00}{0.6} \\ \textcolor{#0000FF}{0.8} \\ 1 \end{pmatrix} = \begin{pmatrix} \textcolor{#FF0000}{0} \\ \textcolor{#01FF00}{0.15} \\ \textcolor{#0000FF}{0.16} \\ 1 \end{pmatrix}
$$
И теперь вектор нормали перестал быть единичным вектором, так же сменилось направление из-за скейлинга. Следовательно, нам надо будет перенормализировать нормаль, что бы он стал опять единичным вектором.

## Заключение

Трансформация нормали из _**Координат Объекта**_ в _**Координаты Наблюдателя**_, умножая на $(M^{-1})^{T}$﻿ будет работать только при условии, что _Матрица Трансформации_ содержит Трансляцию или Поворот. При этом если Матрица Трансформации содержит Скейлинг, то нормаль должна быть перенормирована (она опять должна стать единичным вектором), после трансформации.

Так как Матраци Трансформации, отвечающая только за ПОворот ортогональна (обратная матрица и транспонированная - одинаковы) мы можем скипнуть процесс инвесии и транспонирования.

Для оптимизации перформанса трансформации нормали - лучше всего задать различные _Матрицы_ для нормалей, которые будут содержать только часть с ==Вращением== из _Матрицы Модели/Представления_ (игнорируя трансляцию и скейлинг) и использовать матрицу для трансформации нормали из _**Объектных Координат**_ в _**Координаты Наблюдателя**_ без вычисления обратной и транспонированной матрицы.